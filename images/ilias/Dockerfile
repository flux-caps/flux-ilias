ARG PHP_VERSION
FROM php:$PHP_VERSION-fpm-alpine

LABEL org.opencontainers.image.source="https://github.com/fluxapps/FluxIlias"
LABEL maintainer="fluxlabs <support@fluxlabs.ch> (https://fluxlabs.ch)"

RUN apk add --no-cache curl ffmpeg freetype-dev ghostscript imagemagick libjpeg-turbo-dev libpng-dev libxslt-dev libzip-dev mariadb-client openldap-dev patch su-exec unzip zlib-dev zip && \
    apk add --no-cache --virtual .build-deps $PHPIZE_DEPS && \
    case $PHP_VERSION in 8.*|7.4*) docker-php-ext-configure gd --with-freetype --with-jpeg ;; *) docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ ;; esac && \
    docker-php-ext-install gd ldap mysqli pdo_mysql soap xsl zip && \
    case $PHP_VERSION in 8.*) pecl install "channel://pecl.php.net/xmlrpc-1.0.0RC2" && docker-php-ext-enable xmlrpc ;; *) docker-php-ext-install xmlrpc ;; esac && \
    docker-php-source delete && \
    apk del .build-deps

ENV ILIAS_PDFGENERATION_PATH_TO_PHANTOM_JS /usr/local/bin/phantomjs
RUN curl -Ls "https://github.com/dustinblackman/phantomized/releases/download/2.1.1a/dockerized-phantomjs.tar.gz" | tar xz -C / && curl -k -Ls https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2 | tar -jxvf - -C . && mv phantomjs-2.1.1-linux-x86_64/bin/phantomjs "$ILIAS_PDFGENERATION_PATH_TO_PHANTOM_JS" && rm -fR phantomjs-2.1.1-linux-x86_64

COPY --from=composer:1 /usr/bin/composer /usr/bin/composer1
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer2

ENV _ILIAS_WWW_DATA www-data:www-data
ENV _ILIAS_EXEC_AS_WWW_DATA su-exec $_ILIAS_WWW_DATA

ENV ILIAS_FILESYSTEM_DATA_DIR /var/iliasdata
ENV ILIAS_FILESYSTEM_INI_PHP_FILE $ILIAS_FILESYSTEM_DATA_DIR/ilias.ini.php
ENV ILIAS_LOG_DIR /var/log/ilias
ENV ILIAS_WEB_DIR /var/www/html

ENV _ILIAS_AUTO_SKIP_CONFIG_TEMP_FILE /tmp/auto_skip_config_temp_file

ENV ILIAS_CONFIG_FILE $ILIAS_FILESYSTEM_DATA_DIR/config.json

ENV ILIAS_FILESYSTEM_WEB_DATA_DIR $ILIAS_FILESYSTEM_DATA_DIR/web

ENV ILIAS_PHP_DISPLAY_ERRORS Off
ENV ILIAS_PHP_ERROR_REPORTING E_ALL & ~E_NOTICE & ~E_WARNING & ~E_STRICT
ENV ILIAS_PHP_EXPOSE Off
ENV ILIAS_PHP_LISTEN 0.0.0.0
ENV ILIAS_PHP_LOG_ERRORS On
ENV ILIAS_PHP_MAX_EXECUTION_TIME 900
ENV ILIAS_PHP_MAX_INPUT_TIME 900
ENV ILIAS_PHP_MAX_INPUT_VARS 1000
ENV ILIAS_PHP_MEMORY_LIMIT 300M
ENV ILIAS_PHP_PORT 9000
ENV ILIAS_PHP_POST_MAX_SIZE 200M
ENV ILIAS_PHP_UPLOAD_MAX_SIZE 200M

ENV _ILIAS_WEB_DATA_DIR $ILIAS_WEB_DIR/data
ENV _ILIAS_WEB_PHP_FILE $ILIAS_WEB_DIR/ilias.ini.php

ENV ILIAS_COMMON_CLIENT_ID default
#ENV ILIAS_COMMON_MASTER_PASSWORD
#ENV ILIAS_COMMON_SERVER_TIMEZONE
#ENV ILIAS_COMMON_REGISTER_NIC

#ENV ILIAS_BACKGROUNDTASKS_TYPE
#ENV ILIAS_BACKGROUNDTASKS_MAX_NUMBER_OF_CONCURRENT_TASKS

#ENV ILIAS_DATABASE_TYPE
ENV ILIAS_DATABASE_HOST mysql
#ENV ILIAS_DATABASE_PORT
ENV ILIAS_DATABASE_DATABASE ilias
ENV ILIAS_DATABASE_USER ilias
#ENV ILIAS_DATABASE_PASSWORD
#ENV ILIAS_DATABASE_CREATE_DATABASE
#ENV ILIAS_DATABASE_COLLATION
#ENV ILIAS_DATABASE_PATH_TO_DB_DUMP

#ENV ILIAS_GLOBALCACHE_SERVICE
#ENV ILIAS_GLOBALCACHE_COMPONENTS
#ENV ILIAS_GLOBALCACHE_MEMCACHED_NODES

#ENV ILIAS_HTTP_PATH (Auto set in entrypoint if empty)
#ENV ILIAS_HTTP_HTTPS_AUTODETECTION_HEADER_NAME
#ENV ILIAS_HTTP_HTTPS_AUTODETECTION_HEADER_VALUE
#ENV ILIAS_HTTP_PROXY_HOST
#ENV ILIAS_HTTP_PROXY_PORT

#ENV ILIAS_LANGUAGE_DEFAULT_LANGUAGE
#ENV ILIAS_LANGUAGE_INSTALL_LANGUAGES
#ENV ILIAS_LANGUAGE_INSTALL_LOCAL_LANGUAGES

ENV ILIAS_LOGGING_ENABLE true
ENV ILIAS_LOGGING_PATH_TO_LOGFILE $ILIAS_LOG_DIR/ilias.log
ENV ILIAS_LOGGING_ERRORLOG_DIR $ILIAS_LOG_DIR/errors

#ENV ILIAS_MATHJAX_PATH_TO_LATEX_CGI

ENV ILIAS_MEDIAOBJECT_PATH_TO_FFMPEG /usr/bin/ffmpeg

ENV ILIAS_PREVIEW_PATH_TO_GHOSTSCRIPT /usr/bin/gs

#ENV ILIAS_STYLE_MANAGE_SYSTEM_STYLES
#ENV ILIAS_STYLE_PATH_TO_LESSC

#ENV ILIAS_SYSTEMFOLDER_CLIENT_NAME
#ENV ILIAS_SYSTEMFOLDER_CLIENT_DESCRIPTION
#ENV ILIAS_SYSTEMFOLDER_CLIENT_INSTITUTION

#ENV ILIAS_SYSTEMFOLDER_CONTACT_FIRSTNAME
#ENV ILIAS_SYSTEMFOLDER_CONTACT_LASTNAME
#ENV ILIAS_SYSTEMFOLDER_CONTACT_TITLE
#ENV ILIAS_SYSTEMFOLDER_CONTACT_POSITION
#ENV ILIAS_SYSTEMFOLDER_CONTACT_INSTITUTION
#ENV ILIAS_SYSTEMFOLDER_CONTACT_STREET
#ENV ILIAS_SYSTEMFOLDER_CONTACT_ZIPCODE
#ENV ILIAS_SYSTEMFOLDER_CONTACT_CITY
#ENV ILIAS_SYSTEMFOLDER_CONTACT_COUNTRY
#ENV ILIAS_SYSTEMFOLDER_CONTACT_PHONE
#ENV ILIAS_SYSTEMFOLDER_CONTACT_EMAIL

ENV ILIAS_UTILITIES_PATH_TO_CONVERT /usr/bin/convert
ENV ILIAS_UTILITIES_PATH_TO_ZIP /usr/bin/zip
ENV ILIAS_UTILITIES_PATH_TO_UNZIP /usr/bin/unzip

#ENV ILIAS_VIRUSSCANNER_VIRUSSCANNER
#ENV ILIAS_VIRUSSCANNER_PATH_TO_SCAN
#ENV ILIAS_VIRUSSCANNER_PATH_TO_CLEAN
#ENV ILIAS_VIRUSSCANNER_ICAP_HOST
#ENV ILIAS_VIRUSSCANNER_ICAP_PORT
#ENV ILIAS_VIRUSSCANNER_ICAP_SERVICE_NAME
#ENV ILIAS_VIRUSSCANNER_ICAP_CLIENT_PATH

#ENV ILIAS_PRIVACYSECURITY_HTTPS_ENABLED

#ENV ILIAS_WEBSERVICES_SOAP_USER_ADMINISTRATION
#ENV ILIAS_WEBSERVICES_SOAP_WSDL_PATH
#ENV ILIAS_WEBSERVICES_SOAP_CONNECT_TIMEOUT

ENV ILIAS_WEBSERVICES_RPC_SERVER_HOST ilserver
ENV ILIAS_WEBSERVICES_RPC_SERVER_PORT 11111
#ENV ILIAS_LUEANCE_SEARCH

ENV ILIAS_CHATROOM_ADDRESS 0.0.0.0
ENV ILIAS_CHATROOM_PORT 8080
#ENV ILIAS_CHATROOM_SUB_DIRECTORY
#ENV ILIAS_CHATROOM_HTTPS_CERT
#ENV ILIAS_CHATROOM_HTTPS_KEY
#ENV ILIAS_CHATROOM_HTTPS_DHPARAM
ENV ILIAS_CHATROOM_LOG_DIR /var/log/chatroom
ENV ILIAS_CHATROOM_LOG $ILIAS_CHATROOM_LOG_DIR/chatroom.log
ENV ILIAS_CHATROOM_LOG_LEVEL info
ENV ILIAS_CHATROOM_ERROR_LOG $ILIAS_CHATROOM_LOG_DIR/error.log
#ENV ILIAS_CHATROOM_ILIAS_PROXY_ILIAS_URL (Auto set in entrypoint if empty)
#ENV ILIAS_CHATROOM_CLIENT_PROXY_CLIENT_URL (Auto set in entrypoint if empty)
#ENV ILIAS_CHATROOM_DELETION_INTERVAL_DELETION_UNIT
#ENV ILIAS_CHATROOM_DELETION_INTERVAL_DELETION_VALUE
#ENV ILIAS_CHATROOM_DELETION_INTERVAL_DELETION_TIME

ENV ILIAS_ROOT_USER_LOGIN root
#ENV ILIAS_ROOT_USER_PASSWORD

ENV ILIAS_CRON_USER_LOGIN cron
#ENV ILIAS_CRON_USER_PASSWORD

ENV ILIAS_DEVMODE false

#ENV ILIAS_SMTP_HOST
#ENV ILIAS_SMTP_PORT
#ENV ILIAS_SMTP_ENCRYPTION
#ENV ILIAS_SMTP_USER
#ENV ILIAS_SMTP_PASSWORD

VOLUME $ILIAS_FILESYSTEM_DATA_DIR
VOLUME $ILIAS_LOG_DIR
VOLUME $ILIAS_WEB_DIR

EXPOSE $ILIAS_PHP_PORT

WORKDIR $ILIAS_WEB_DIR

COPY ./scripts /scripts

COPY ./entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
